< !DOCTYPE html>
    <html lang="ko">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WebSocket Blob ì „ì†¡</title>
    </head>

    <body>
        <h1>WebSocket Blob ì „ì†¡ ì˜ˆì œ</h1>

        <!-- ë¹„ë””ì˜¤ ìš”ì†Œ -->
        <video id="video" autoplay playsinline width="640" height="480" muted></video>

        <script>
            // WebSocket ì„œë²„ì™€ ì—°ê²°
            const socket = new WebSocket('ws://localhost:8080/ws-stream');

            // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì„¤ì •
            const videoElement = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // WebSocket ì—°ê²°ì´ ì—´ë¦¬ë©´
            socket.onopen = function (event) {
                console.log("WebSocket ì—°ê²° ì„±ê³µ");
            };

            // WebSocket ì˜¤ë¥˜ ì²˜ë¦¬
            socket.onerror = function (error) {
                console.log("WebSocket ì˜¤ë¥˜:", error);
            };

            // WebSocket ì—°ê²° ì¢…ë£Œ ì‹œ ì²˜ë¦¬
            socket.onclose = function (event) {
                console.log("WebSocket ì—°ê²° ì¢…ë£Œ");
            };

            // ë¹„ë””ì˜¤ì—ì„œ 1ì´ˆë§ˆë‹¤ í”„ë ˆì„ì„ ìº¡ì²˜í•˜ì—¬ Blobìœ¼ë¡œ ì„œë²„ë¡œ ì „ì†¡
            function captureAndSendFrame() {
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(function (blob) {
                    if (!blob) {
                        console.error("âŒ Blob ìƒì„± ì‹¤íŒ¨: canvasì— ê·¸ë ¤ì§„ ë‚´ìš©ì´ ì—†ê±°ë‚˜ canvas í¬ê¸°ê°€ 0ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                        return;
                    }

                    if (socket.readyState === WebSocket.OPEN) {
                        const reader = new FileReader();

                        reader.onloadend = () => {
                            const base64Image = reader.result.split(',')[1];

                            const message = {
                                destination: "/pub/live/image/",
                                type: "IMAGE",
                                data: base64Image,
                            };

                            socket.send(JSON.stringify(message));
                            console.log("ğŸ“¤ pub to /pub/live/image/");
                        };

                        reader.readAsDataURL(blob);
                    } else {
                        console.warn("âš ï¸ WebSocket ì—°ê²°ì´ ì•„ì§ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    }
                }, 'image/jpeg', 0.8);


            }

            // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
            navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                }
            })
                .then(function (stream) {
                    videoElement.srcObject = stream;

                    videoElement.addEventListener("loadedmetadata", () => {
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;

                        console.log("âœ… ë¹„ë””ì˜¤ í¬ê¸° ì„¤ì •ë¨:", canvas.width, canvas.height);

                        setInterval(captureAndSendFrame, 100);
                    });
                })
                .catch(function (err) {
                    console.error("ğŸš« ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜:", err);
                });

        </script>
    </body>

    </html>