< !DOCTYPE html>
    <html lang="ko">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WebSocket Blob 전송</title>
    </head>

    <body>
        <h1>WebSocket Blob 전송 예제</h1>

        <!-- 비디오 요소 -->
        <video id="video" autoplay playsinline width="640" height="480" muted></video>

        <script>
            // WebSocket 서버와 연결
            const socket = new WebSocket('ws://localhost:8080/ws-stream');

            // 비디오 스트림 설정
            const videoElement = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // WebSocket 연결이 열리면
            socket.onopen = function (event) {
                console.log("WebSocket 연결 성공");
            };

            // WebSocket 오류 처리
            socket.onerror = function (error) {
                console.log("WebSocket 오류:", error);
            };

            // WebSocket 연결 종료 시 처리
            socket.onclose = function (event) {
                console.log("WebSocket 연결 종료");
            };

            // 비디오에서 1초마다 프레임을 캡처하여 Blob으로 서버로 전송
            function captureAndSendFrame() {
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(function (blob) {
                    if (!blob) {
                        console.error("❌ Blob 생성 실패: canvas에 그려진 내용이 없거나 canvas 크기가 0일 수 있습니다.");
                        return;
                    }

                    if (socket.readyState === WebSocket.OPEN) {
                        const reader = new FileReader();

                        reader.onloadend = () => {
                            const base64Image = reader.result.split(',')[1];

                            const message = {
                                destination: "/pub/live/image/",
                                type: "IMAGE",
                                data: base64Image,
                            };

                            socket.send(JSON.stringify(message));
                            console.log("📤 pub to /pub/live/image/");
                        };

                        reader.readAsDataURL(blob);
                    } else {
                        console.warn("⚠️ WebSocket 연결이 아직 열려있지 않습니다.");
                    }
                }, 'image/jpeg', 0.8);


            }

            // 비디오 스트림 시작
            navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                }
            })
                .then(function (stream) {
                    videoElement.srcObject = stream;

                    videoElement.addEventListener("loadedmetadata", () => {
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;

                        console.log("✅ 비디오 크기 설정됨:", canvas.width, canvas.height);

                        setInterval(captureAndSendFrame, 100);
                    });
                })
                .catch(function (err) {
                    console.error("🚫 비디오 스트림 오류:", err);
                });

        </script>
    </body>

    </html>